# Orchestrator Agent Configuration
# This agent coordinates disaster response by validating reports,
# calling analysis agents, and managing the priority queue

log:
  stdout_log_level: INFO
  log_file_level: DEBUG
  log_file: orchestrator-agent.log

!include ../shared_config.yaml

apps:
  - name: orchestrator-agent
    app_module: solace_agent_mesh.agent.sac.app
    broker:
      <<: *broker_connection

    app_config:
      namespace: "${NAMESPACE}"
      agent_name: "OrchestratorAgent"
      display_name: "Disaster Response Orchestrator"
      supports_streaming: true  # Enable streaming for conversational flow
      
      # LLM Model Configuration
      model: *general_model
      
      # Agent Instructions - Critical for coordinating the workflow
      instruction: |
        You are the Disaster Response Orchestrator. Your job is to gather complete information 
        about disaster victims and coordinate their rescue prioritization.
        
        CRITICAL INFORMATION REQUIRED:
        1. Location (latitude/longitude OR city/address)
        2. Description of the situation (injuries, hazards, urgency)
        3. Number of people affected
        
        WORKFLOW - FOLLOW THESE STEPS IN ORDER:
        
        STEP 1: VALIDATE INFORMATION
        - When a user reports a disaster, call validate_victim_report with whatever info they provided
        - The tool will tell you what's missing
        
        STEP 2: GATHER MISSING INFORMATION
        - If validation returns is_valid=False:
          * Ask the user the specific question from "next_question" field
          * Wait for their response
          * Call validate_victim_report again with the new information
        - Repeat until is_valid=True
        - Ask questions ONE AT A TIME to avoid overwhelming the user
        
        STEP 3: PROCESS COMPLETE REPORT
        - ONLY after is_valid=True, call process_validated_report
        - This will:
          * Send location immediately to rescue teams
          * Analyze severity, resources, and hospital needs
          * Add to priority queue
        
        CONVERSATION STYLE:
        - Be empathetic but efficient - lives are at stake
        - Keep questions clear and direct
        - Acknowledge the user's stress and fear
        - Provide reassurance when possible
        
        EXAMPLE CONVERSATION:
        User: "Help! There's been an accident!"
        You: "I'm here to help. What is your exact location?"
        User: "123 Main Street, Springfield"
        You: "Thank you. Can you describe what happened and if anyone is injured?"
        User: "Car crash, two people injured, one unconscious"
        You: "How many people need assistance total?"
        User: "Two people"
        You: [calls process_validated_report] "Emergency services have been notified and 
             are being dispatched to 123 Main Street. The situation has been prioritized 
             based on the unconscious victim. Help is on the way. Please stay safe."
        
        Remember: Complete information saves lives by ensuring accurate prioritization.
      
      # Lifecycle Functions - Run on startup/shutdown
      agent_init_function:
        module: "src.orchestrator_agent.lifecycle"
        name: "initialize_orchestrator_agent"
        base_path: .
        config:
          startup_message: "Orchestrator Agent is ready to coordinate disaster response!"
          max_queue_size: 1000
      
      agent_cleanup_function:
        module: "src.orchestrator_agent.lifecycle"
        base_path: .
        name: "cleanup_orchestrator_agent"
      
      # Tools Configuration
      tools:
        # Validation tool - Check if report has all required info
        - tool_type: python
          component_module: "src.orchestrator_agent.tools"
          component_base_path: .
          function_name: "validate_victim_report"
          tool_description: "Validate if victim report has all required information (location, description, num_people)"
        
        # Processing tool - Process a complete report
        - tool_type: python
          component_module: "src.orchestrator_agent.tools"
          component_base_path: .
          function_name: "process_validated_report"
          tool_description: "Process a validated victim report - ONLY call after validation confirms completeness"
        
        # Queue management tools
        - tool_type: python
          component_module: "src.orchestrator_agent.tools"
          component_base_path: .
          function_name: "get_priority_queue"
          tool_description: "Get the current priority queue of victims awaiting rescue"
        
        - tool_type: python
          component_module: "src.orchestrator_agent.tools"
          component_base_path: .
          function_name: "update_victim_status"
          tool_description: "Update the status of a victim (pending, in_progress, resolved)"
        
        # Built-in artifact tools for file operations
        - tool_type: builtin-group
          group_name: "artifact_management"
      
      # Services Configuration
      session_service: *default_session_service
      artifact_service: *default_artifact_service  # Required for priority queue persistence
      
      # Artifact handling
      artifact_handling_mode: "reference"
      enable_embed_resolution: true
      enable_artifact_content_instruction: true
      
      # Agent Card - Describes capabilities to other agents
      agent_card:
        description: "Disaster response orchestrator that validates reports, coordinates analysis, and manages rescue prioritization"
        defaultInputModes: ["text"]
        defaultOutputModes: ["text", "file"]
        skills:
          - id: "validate_report"
            name: "Validate Victim Report"
            description: "Check if disaster report has all required information"
          - id: "process_report"
            name: "Process Disaster Report"
            description: "Coordinate severity analysis, resource estimation, and priority queue management"
          - id: "manage_queue"
            name: "Manage Priority Queue"
            description: "View and update the priority queue of victims awaiting rescue"
      
      # Agent Card Publishing
      agent_card_publishing:
        interval_seconds: 30
      
      # Agent Discovery - Allow other agents to find this orchestrator
      agent_discovery:
        enabled: true
      
      # Inter-agent Communication
      inter_agent_communication:
        allow_list: ["SeverityAgent", "ResourcesAgent", "HospitalAgent"]
        request_timeout_seconds: 30